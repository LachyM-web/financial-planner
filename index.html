<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Planner – Piso $400, Renta $1600, Apple total, Freedom libre, Seguro 12, Capital One seleccionable/forzado</title>
<style>
  :root{
    --bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--brand:#22c55e;--danger:#ef4444;--warn:#f59e0b;--line:#1f2937
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(15,23,42,.7);backdrop-filter:blur(8px)}
  header h1{margin:0;font-size:18px}
  main{max-width:1160px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  h2{font-size:16px;margin:0 0 10px}
  label{font-size:13px;color:var(--muted)}
  input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
  .row{display:grid;gap:8px}
  @media(min-width:680px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}.row-4{grid-template-columns:1fr 1fr 1fr 1fr}}
  .pill{display:inline-block;padding:6px 10px;border-radius:100px;background:#0b1220;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .kpis{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
  @media(min-width:680px){.kpis{grid-template-columns:repeat(5,1fr)}}
  .kpi{padding:12px;border:1px dashed #243045;border-radius:12px}
  .kpi .big{font-size:22px;font-weight:700}
  .ok{color:var(--brand)} .bad{color:var(--danger)} .warn{color:var(--warn)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
  th{color:var(--muted);font-weight:600;text-align:left}
  tr:last-child td{border-bottom:none}
  .mini{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{cursor:pointer}
  .btn.primary{background:var(--brand);border:none;color:#052e16;font-weight:700}
  .btn.ghost{background:#0b1220;border:1px solid var(--line)}
  .btn.warn{background:var(--warn);border:none;color:#1f2a06}
  .tag{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;color:var(--muted)}
  canvas{width:100%;height:220px;border:1px solid var(--line);border-radius:12px;background:#0b1220}
  .error{display:none;background:#ffe7e7;border:1px solid #ffbdbd;color:#8a1f1f;padding:10px;border-radius:8px;white-space:pre-wrap}
</style>
</head>
<body>
<header><h1>Planner — Pagos restan, viernes suman, piso $400, renta $1600, Apple total</h1></header>
<main class="grid">
  <!-- KPIs -->
  <section class="card">
    <div class="kpis">
      <div class="kpi"><div class="mini">Saldo actual</div><div id="kSaldo" class="big">$0.00</div></div>
      <div class="kpi"><div class="mini">Piso mínimo</div><div id="kFloor" class="big">$400.00</div></div>
      <div class="kpi"><div class="mini">Obligatorio restante</div><div id="kHold" class="big warn">$0.00</div></div>
      <div class="kpi"><div class="mini">Renta (próx. 1)</div><div id="kRent" class="big">$1,600.00</div></div>
      <div class="kpi"><div class="mini">Libre seguro</div><div id="kSafe" class="big ok">$0.00</div></div>
    </div>
    <div style="margin:12px 0">
      <span class="pill" id="periodLabel"></span>
      <span class="pill">Autosave local</span>
      <span class="pill">Viernes suman</span>
      <span class="pill">Pagos restan</span>
    </div>
    <canvas id="chart"></canvas>
  </section>

  <!-- Configuración -->
  <section class="card">
    <h2>Configuración</h2>
    <div class="row row-4">
      <div><label>Mes</label><input id="month" type="month"/></div>
      <div><label>Saldo inicial ($)</label><input id="saldo" value="2200" inputmode="decimal"/></div>
      <div><label>Piso mínimo ($)</label><input id="minBal" value="400" inputmode="decimal"/></div>
      <div><label>Renta (día 1 sig. mes) ($)</label><input id="rent" value="1600" inputmode="decimal"/></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="saveConfig">Guardar config</button>
      <button class="btn ghost" id="clear">Limpiar todo</button>
    </div>
  </section>

  <!-- Ingresos -->
  <section class="card">
    <h2>Ingresos</h2>
    <div class="row row-3">
      <div><label>Monto por viernes ($)</label><input id="weekly" value="700" inputmode="decimal"/></div>
      <div><label>Agregar ingresos de los viernes</label><select id="autoFri"><option value="on" selected>Sí</option><option value="off">No</option></select></div>
      <div style="align-self:end"><input type="checkbox" id="omitFirst" checked/><label for="omitFirst">Omitir 1er viernes (ya cobrado)</label></div>
    </div>
    <div class="row row-3" style="margin-top:8px">
      <div><label>Ingreso manual — Fecha</label><input id="mInDate" type="date"/></div>
      <div><label>Ingreso manual — Monto ($)</label><input id="mInAmt" placeholder="900" inputmode="decimal"/></div>
      <div style="align-self:end"><button class="btn primary" id="addIncome">Agregar ingreso</button></div>
    </div>
    <div class="mini">Viernes suman. Pagos restan. “Libre seguro” = Saldo − Piso − Obligatorio restante.</div>
  </section>

  <!-- Deudas y pagos -->
  <section class="card">
    <h2>Deudas y pagos del mes</h2>
    <div class="row row-4">
      <div><label>Apple Card — deuda ($)</label><input id="appleDebt" value="1024" inputmode="decimal"/></div>
      <div><label>Freedom (Chase) — deuda ($)</label><input id="freedomDebt" value="620" inputmode="decimal"/></div>
      <div><label>Freedom — pago del 11 ($)</label><input id="freedomPay" value="620" inputmode="decimal"/></div>
      <div><label>Capital One — deuda ($)</label><input id="capDebt" value="717" inputmode="decimal"/></div>
    </div>
    <div class="row row-4" style="margin-top:8px">
      <div><label>Capital One — pago del 29 ($)</label><input id="capPay" value="717" inputmode="decimal"/></div>
      <div style="align-self:end"><input type="checkbox" id="capForce"/><label for="capForce">Forzar pago exacto</label></div>
      <div><label>Seguro del coche — día 12 ($)</label><input id="carIns" value="335" inputmode="decimal"/></div>
      <div style="align-self:end"><button class="btn primary" id="updateDebts">Actualizar deudas</button></div>
    </div>
    <div class="mini">Pagos fijos: 6 (Préstamo $104), 11 (Freedom), 12 (Teléfono $100 + Seguro), 13 ($500), 27 (Apple total), 29 (Capital One), 1 (Renta sig.).</div>
  </section>

  <!-- Otros gastos -->
  <section class="card">
    <h2>Otros gastos</h2>
    <div class="row row-4">
      <div><label>Fecha</label><input id="ogDate" type="date"/></div>
      <div><label>Detalle</label><input id="ogWhat" placeholder="Gasolina / Supermercado…"/></div>
      <div><label>Monto ($)</label><input id="ogAmt" placeholder="120" inputmode="decimal"/></div>
      <div style="align-self:end"><input type="checkbox" id="ogMandatory"/><label for="ogMandatory">Obligatorio</label></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="addOther">Agregar gasto</button>
      <button class="btn ghost" id="clearOthers">Limpiar lista</button>
    </div>
    <div class="mini">Obligatorios se reservan. Opcionales usan libre-seguro.</div>
    <table id="ogTable" style="margin-top:8px">
      <thead><tr><th>Fecha</th><th>Detalle</th><th>Monto</th><th>Tipo</th><th>Acción</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Sugerencias -->
  <section class="card">
    <h2>Parámetros sugeridos</h2>
    <div id="sugText" class="mini">Pulsa “Calcular sugerencias”.</div>
    <div class="actions" style="margin-top:8px">
      <button class="btn warn" id="calcSug">Calcular sugerencias</button>
      <button class="btn primary" id="applySug">Aplicar sugerencias</button>
    </div>
  </section>

  <!-- Acciones -->
  <section class="card">
    <div class="actions">
      <button class="btn primary" id="gen">Generar plan</button>
      <button class="btn ghost" id="exportCsv">Exportar CSV</button>
      <button class="btn ghost" id="exportIcs">Exportar ICS</button>
      <button class="btn ghost" id="save">Guardar</button>
      <button class="btn ghost" id="load">Cargar</button>
      <button class="btn warn" onclick="window.print()">Imprimir / PDF</button>
    </div>
    <div id="err" class="error" style="margin-top:8px"></div>
  </section>

  <!-- Línea de tiempo -->
  <section class="card">
    <h2>Línea de tiempo</h2>
    <table id="tblPlan">
      <thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Monto</th><th>Saldo después</th><th>Nota</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="planSummary" class="mini" style="margin-top:8px"></div>
  </section>
</main>

<script>
(function(){
  // ===== Utilidades =====
  function $(id){return document.getElementById(id);}
  function N(v){var x=parseFloat((v??"").toString().replace(",","."));return isFinite(x)?x:0;}
  function money(n){n=Number(n||0);const s=n<0?"-":"";return s+"$"+Math.abs(n).toFixed(2);}
  function ymd(y,m,d){return y+"-"+("0"+m).slice(-2)+"-"+("0"+d).slice(-2);}
  function parseMonth(s){if(!/^\d{4}-\d{2}$/.test(s||""))return null;return{y:+s.slice(0,4),m:+s.slice(5,7)};}
  function fridays(y,m){const d=new Date(y,m-1,1),out=[];while(d.getMonth()===m-1){if(d.getDay()===5)out.push(ymd(y,m,d.getDate()));d.setDate(d.getDate()+1)}return out;}
  function showErr(msg){const e=$("err");e.style.display="block";e.textContent=msg;}
  function clearErr(){const e=$("err");e.style.display="none";e.textContent="";}
  function setKpis(k){
    $("kSaldo").textContent=money(k.saldo);
    $("kFloor").textContent=money(k.floor);
    $("kRent").textContent=money(k.rent);
    $("kHold").textContent=money(k.hold);
    $("kSafe").textContent=money(k.safe);
  }
  function nextMonth(y,m){return m===12?{y:y+1,m:1}:{y,m:m+1};}
  function pill(ok, text){ return `<span class="pill ${ok===true?'ok':ok===false?'bad':'warn'}">${text}</span>`; }
  function todayLocalISO(){const d=new Date();const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();return y+"-"+("0"+m).slice(-2)+"-"+("0"+dd).slice(-2);}
  function currentMonthLocal(){const d=new Date();const y=d.getFullYear(), m=d.getMonth()+1;return y+"-"+("0"+m).slice(-2);}
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function nextDueFromRule(rule, y, m){
    const lastDay = new Date(y, m, 0).getDate();
    if(/^D(\d{1,2})$/.test(rule)) return ymd(y,m,Math.min(Number(rule.slice(1)), lastDay));
    if(/^EOM-(\d+)$/.test(rule)) return ymd(y,m,Math.max(1, lastDay - Number(rule.split('-')[1])));
    return ymd(y,m,15);
  }
  function pad(n){return String(n).padStart(2,'0');}
  function addDaysISO(iso, days){
    const [Y,M,D]=iso.split('-').map(Number);
    const d=new Date(Y, M-1, D+days);
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
  }
  function escapeICS(s){
    return String(s)
      .replace(/\\/g,'\\\\')
      .replace(/,/g,'\\,')
      .replace(/;/g,'\\;')
      .replace(/\r?\n/g,'\\n');
  }

  // ===== Estado =====
  const KEY='planner_combined_v2';
  const state = load() || {
    month: currentMonthLocal(),
    saldo: 2200,
    minBal: 400,
    rent: 1600,
    weekly: 700,
    autoFri: 'on',
    omitFirst: true,
    appleDebt: 1024,
    freedomDebt: 620,
    freedomPay: 620,
    capDebt: 717,
    capPay: 717,
    capForce: false,
    carIns: 335,
    manualIncomes: [],
    otherOutlays: [],
    recurrents: [
      {id:uid(), name:'Préstamo estudiantil', amt:104, day:6},
      {id:uid(), name:'Teléfono', amt:100, day:12},
      {id:uid(), name:'Pago recurrente', amt:500, day:13}
    ],
    cards: [
      {id:uid(), name:'Apple Card', debt:1024, pay:0, rule:'EOM-3'},
      {id:uid(), name:'Freedom (Chase)', debt:620, pay:620, rule:'D11'},
      {id:uid(), name:'Capital One', debt:717, pay:717, rule:'D29'}
    ]
  };

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }

  // ===== Inicialización =====
  (function init(){
    $("month").value = state.month;
    const today = todayLocalISO();
    $("mInDate").value = today;
    $("ogDate").value = today;
    $("saldo").value = state.saldo;
    $("minBal").value = state.minBal;
    $("rent").value = state.rent;
    $("weekly").value = state.weekly;
    $("autoFri").value = state.autoFri;
    $("omitFirst").checked = state.omitFirst;
    $("appleDebt").value = state.appleDebt;
    $("freedomDebt").value = state.freedomDebt;
    $("freedomPay").value = state.freedomPay;
    $("capDebt").value = state.capDebt;
    $("capPay").value = state.capPay;
    $("capForce").checked = state.capForce;
    $("carIns").value = state.carIns;
    renderOtherOutlays();
    renderKpis();
  })();

  // ===== Ingresos manuales =====
  $("addIncome").onclick=function(){
    const d=$("mInDate").value.trim(), a=N($("mInAmt").value);
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return showErr("Fecha ingreso manual inválida");
    if(a<=0) return showErr("Monto ingreso manual inválido");
    state.manualIncomes.push({date:d,amount:a});
    $("mInAmt").value="";
    save(); clearErr();
    renderKpis();
  };

  // ===== Otros gastos =====
  function renderOtherOutlays(){
    const tb = $("ogTable").querySelector("tbody");
    tb.innerHTML="";
    state.otherOutlays.forEach((g,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${g.date}</td>
        <td>${g.what||""}</td>
        <td>${money(g.amt)}</td>
        <td>${g.mandatory?'<span class="tag">Obligatorio</span>':'<span class="tag">Opcional</span>'}</td>
        <td><button class="btn ghost" data-i="${idx}">Borrar</button></td>`;
      tb.appendChild(tr);
    });
    [...tb.querySelectorAll("button")].forEach(btn=>{
      btn.onclick=function(){ const i=+this.getAttribute("data-i"); state.otherOutlays.splice(i,1); renderOtherOutlays(); save(); renderKpis(); };
    });
  }
  $("addOther").onclick=function(){
    const d=$("ogDate").value.trim(), w=$("ogWhat").value.trim(), a=N($("ogAmt").value), mand=$("ogMandatory").checked;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return showErr("Fecha de gasto inválida");
    if(a<=0) return showErr("Monto de gasto inválido");
    state.otherOutlays.push({date:d, what:w, amt:a, mandatory:mand});
    $("ogWhat").value="";$("ogAmt").value="";$("ogMandatory").checked=false;
    renderOtherOutlays(); save(); clearErr(); renderKpis();
  };
  $("clearOthers").onclick=function(){ state.otherOutlays=[]; renderOtherOutlays(); save(); renderKpis(); };

  // ===== Guardar / Cargar =====
  $("save").onclick=function(){ save(); };
  $("load").onclick=function(){ location.reload(); };

  // ===== Exportar CSV =====
  $("exportCsv").onclick=function(){
    const rows=[["Fecha","Tipo","Detalle","Monto","Saldo después","Nota"]];
    const trs=[...$("tblPlan").querySelector("tbody").children];
    trs.forEach(tr=>{
      const tds=[...tr.children].map(td=>td.textContent.replace(/,/g,""));
      rows.push(tds);
    });
    const csv=rows.map(r=>r.map(x=>`"${x}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="plan.csv"; a.click();
    URL.revokeObjectURL(url);
  };

  // ===== Exportar ICS (solo PAGO, all-day correcto, alarma -1 día) =====
  $("exportIcs").onclick=function(){
    const trs=[...$("tblPlan").querySelector("tbody").children];
    if(trs.length === 0) { showErr("Genera el plan primero"); return; }
    clearErr();

    function toICSDate(iso){ return iso.replaceAll("-",""); }
    function utcStamp(){
      const d=new Date(); const p=n=>String(n).padStart(2,"0");
      return d.getUTCFullYear()+p(d.getUTCMonth()+1)+p(d.getUTCDate())+"T"+p(d.getUTCHours())+p(d.getUTCMinutes())+p(d.getUTCSeconds())+"Z";
    }

    const lines = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "CALSCALE:GREGORIAN",
      "PRODID:-//PlannerCombined//ES"
    ];
    const stamp = utcStamp();

    trs.forEach((tr, idx) => {
      const tds = [...tr.children];
      const tipo  = tds[1].textContent.trim();
      if (tipo !== "PAGO") return; // solo pagos

      const fecha = tds[0].textContent.trim();           // YYYY-MM-DD
      const det   = tds[2].textContent.trim();
      const montoTxt = tds[3].textContent.trim();        // puede traer -$123.00 (con span)
      const nota  = tds[5].textContent.trim();

      const absMonto = Math.abs(parseFloat((montoTxt.match(/-?\d+(\.\d+)?/)||["0"])[0])).toFixed(2);
      const startISO = fecha;
      const endISO   = addDaysISO(fecha, 1);             // all-day => DTEND al día siguiente
      const yyyymmdd = toICSDate(startISO);
      const yyyymmdd_end = toICSDate(endISO);
      const uid = `planner-${yyyymmdd}-${idx}@planner`;

      const summary = `PAGO: ${det} — $${absMonto}`;
      const desc = nota ? `Nota: ${nota}` : "";

      lines.push(
        "BEGIN:VEVENT",
        `UID:${uid}`,
        `DTSTAMP:${stamp}`,
        `DTSTART;VALUE=DATE:${yyyymmdd}`,
        `DTEND;VALUE=DATE:${yyyymmdd_end}`,
        `SUMMARY:${escapeICS(summary)}`,
        `DESCRIPTION:${escapeICS(desc)}`,
        "BEGIN:VALARM",
        "TRIGGER:-P1D",
        "ACTION:DISPLAY",
        "DESCRIPTION:Recordatorio de pago",
        "END:VALARM",
        "END:VEVENT"
      );
    });

    lines.push("END:VCALENDAR");

    const blob = new Blob([lines.join("\r\n")], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `pagos-${state.month}.ics`; a.click();
    URL.revokeObjectURL(url);
  };

  // ===== Motor de simulación =====
  function buildEvents(y,m){
    const ev=[];
    // Ingresos viernes
    if(state.autoFri==='on'){
      fridays(y,m).forEach((d,idx)=>{ if(state.omitFirst && idx===0) return; ev.push({date:d,kind:"INGRESO",txt:"Ingreso viernes",amt:state.weekly}); });
    }
    // Ingresos manuales
    state.manualIncomes.forEach(mi=>{ if(mi.date.slice(0,7)===ymd(y,m,1).slice(0,7)) ev.push({date:mi.date,kind:"INGRESO",txt:"Ingreso manual",amt:mi.amount}); });
    // Recurrentes (obligatorios)
    state.recurrents.forEach(r=>{
      const day = Math.min(31, Math.max(1, r.day));
      ev.push({date:ymd(y,m,day),kind:"PAGO",txt:r.name,amt:r.amt,mandatory:true});
    });
    // Tarjetas
    state.cards.forEach(c=>{
      const due=nextDueFromRule(c.rule, y, m);
      let amt = N(c.pay);
      if(c.rule==='EOM-3' && amt===0) amt = N(c.debt); // Apple total
      const isCapitalOne = c.name==='Capital One' && c.rule==='D29';
      ev.push({
        date:due, kind:"PAGO", txt:`Pago ${c.name}`, amt:amt,
        mandatory:!isCapitalOne, optional:isCapitalOne, force:(isCapitalOne && state.capForce)
      });
    });
    // Seguro obligatorio
    ev.push({date:ymd(y,m,12),kind:"PAGO",txt:"Seguro del coche",amt:state.carIns,mandatory:true});
    // Renta obligatoria (mes siguiente)
    const nm=nextMonth(y,m);
    ev.push({date:ymd(nm.y,nm.m,1), kind:"PAGO", txt:"Renta (mes siguiente)", amt:state.rent, mandatory:true});
    // Otros
    state.otherOutlays.forEach(g=>{
      if(g.date.slice(0,7)===ymd(y,m,1).slice(0,7)){
        ev.push({date:g.date, kind:"PAGO", txt:(g.what||"Otro gasto"), amt:N(g.amt), mandatory:!!g.mandatory, isOther:true});
      }
    });
    ev.sort((a,b)=>{
      if(a.date===b.date){
        if(a.kind!==b.kind) return a.kind==="INGRESO"?-1:1;
        return a.mandatory?-1:1;
      }
      return a.date<b.date?-1:1;
    });
    return ev;
  }

  // Suma SOLO lo obligatorio para “hold”
  function initialMandatory(){
    let t = state.rent + state.carIns;
    state.recurrents.forEach(r=> t+=r.amt);
    state.cards.forEach(c=>{
      let amt = N(c.pay);
      if(c.rule==='EOM-3' && amt===0) amt = N(c.debt);
      if(!(c.name==='Capital One' && c.rule==='D29')) t += amt; // Capital One es opcional
    });
    state.otherOutlays.forEach(g=>{ if(g.mandatory) t+=N(g.amt); });
    return t;
  }

  function simulateMonth(y,m,renderCb){
    let saldo = state.saldo, floor=state.minBal, rent=state.rent;
    let mandatoryLeft = initialMandatory();
    const ev = buildEvents(y,m);

    let totIncome=0, totPayments=0, pisoViolado=false, rentaPagada=false, applePagado=false, missedMandatory=false;
    let cat={prestamo:0,telefono:0,seguro:0,recurrente:0,apple:0,freedom:0,capone:0,renta:0,otros:0};
    let capPagoReal=0, capDebt=state.cards.find(c=>c.name==='Capital One')?.debt||0;
    let freedomDebt=state.cards.find(c=>c.name==='Freedom (Chase)')?.debt||0;
    let appleDebt=state.cards.find(c=>c.name==='Apple Card')?.debt||0;

    function refreshKpis(){ const safe=Math.max(0, saldo - floor - mandatoryLeft); setKpis({saldo, floor, rent, hold:mandatoryLeft, safe}); }

    for(const e of ev){
      if(e.kind==="INGRESO"){
        saldo+=e.amt; totIncome+=e.amt;
        renderCb&&renderCb(e.date, "INGRESO", e.txt, e.amt, saldo, "");
        refreshKpis(); continue;
      }

      let monto = e.amt;

      // --- OPCIONALES (no deben reducir mandatoryLeft) ---
      if(e.optional){
        const desired = monto;
        if(e.force){
          const pay = Math.min(desired, Math.max(0, saldo - floor));
          const nota = (pay<desired)?("⚠️ Forzado: faltan "+money(desired-pay)):"Forzado";
          if(pay>0){ saldo-=pay; capDebt-=pay; capPagoReal+=pay; totPayments+=pay; cat.capone+=pay; }
          renderCb&&renderCb(e.date, "PAGO", e.txt, -pay, saldo, nota);
          refreshKpis(); continue;
        }else{
          const pay = Math.min(desired, Math.max(0, saldo - floor - mandatoryLeft));
          const nota = (pay<desired)?("⚠️ Ajustado: faltan "+money(desired-pay)):"";
          if(pay>0){ saldo-=pay; capDebt-=pay; capPagoReal+=pay; totPayments+=pay; cat.capone+=pay; }
          renderCb&&renderCb(e.date, "PAGO", e.txt, -pay, saldo, nota);
          refreshKpis(); continue;
        }
      }

      // --- NORMALIZA MONTOS ESPECIALES ---
      if(e.txt.includes("Apple")) monto = appleDebt;
      if(e.txt.includes("Freedom")) monto = Math.min(freedomDebt, state.freedomPay);

      // --- NO OBLIGATORIOS (otros opcionales) ---
      if(!e.mandatory){
        const pay = Math.min(monto, Math.max(0, saldo - floor - mandatoryLeft));
        const nota = (pay<monto)?("⚠️ Opcional ajustado: faltan "+money(monto-pay)):"";
        if(pay>0){ saldo-=pay; totPayments+=pay; cat.otros+=pay; }
        renderCb&&renderCb(e.date, "PAGO", e.txt, -pay, saldo, nota);
        refreshKpis(); continue;
      }

      // --- OBLIGATORIOS ---
      if(saldo - monto < floor){
        renderCb&&renderCb(e.date, "PAGO", e.txt, 0, saldo, "🚨 Violación del piso");
        pisoViolado=true; missedMandatory=true; refreshKpis(); continue;
      }
      saldo-=monto; totPayments+=monto; mandatoryLeft=Math.max(0,mandatoryLeft-monto);
      if(e.txt.includes("Apple")){ appleDebt-=monto; cat.apple+=monto; if(appleDebt<=0) applePagado=true; }
      else if(e.txt.includes("Freedom")){ freedomDebt-=monto; cat.freedom+=monto; }
      else if(e.txt.includes("Capital One")){ capDebt-=monto; cat.capone+=monto; } // si llegara marcado obligatorio
      else if(e.txt.includes("Renta")){ cat.renta+=monto; rentaPagada=(monto>=rent); }
      else if(e.txt.includes("Préstamo")){ cat.prestamo+=monto; }
      else if(e.txt.includes("Teléfono")){ cat.telefono+=monto; }
      else if(e.txt.includes("Seguro")){ cat.seguro+=monto; }
      else if(e.txt.includes("recurrente")){ cat.recurrente+=monto; }
      else if(e.isOther){ cat.otros+=monto; }

      renderCb&&renderCb(e.date, "PAGO", e.txt, -monto, saldo, "Obligatorio");
      refreshKpis();
    }

    return {saldo, totIncome, totPayments, pisoViolado, rentaPagada, applePagado, missedMandatory, cat, capPagoReal, capDebt, freedomDebt};
  }

  // ===== Generar plan =====
  function generatePlan(){
    clearErr();
    const pm=parseMonth(state.month); if(!pm) return showErr("Mes inválido");
    const y=pm.y, m=pm.m;
    const tb=$("tblPlan").querySelector("tbody"); tb.innerHTML="";
    const summaryEl=$("planSummary"); summaryEl.innerHTML="";

    const res = simulateMonth(y,m,(date, type, txt, amt, saldo, note)=>{
      const prettyAmt = (type==="INGRESO") ? `<span class="ok">${money(amt)}</span>` :
                       (type==="PAGO" && amt!=0) ? `<span class="bad">${money(amt)}</span>` : money(0);
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${date}</td><td>${type}</td><td>${txt}</td><td>${prettyAmt}</td><td>${money(saldo)}</td><td class="mini">${note}</td>`;
      tb.appendChild(tr);
    });

    const flujo = res.totIncome - res.totPayments;
    let verdict, vClass;
    if(!res.pisoViolado && res.applePagado && res.rentaPagada && !res.missedMandatory){
      verdict = "OK — Piso, Apple y renta OK"; vClass="ok";
    }else if(!res.pisoViolado){
      verdict = "RIESGO — Revisa Apple/Renta"; vClass="warn";
    }else{
      verdict = "FALLÓ — Piso violado"; vClass="bad";
    }

    summaryEl.innerHTML = `
      Ingresos: <b>${money(res.totIncome)}</b> · Pagos: <b>${money(res.totPayments)}</b> · Flujo: <b>${money(flujo)}</b><br/>
      Saldo final: <b>${money(res.saldo)}</b> · Semáforo: <b class="pill ${vClass}">${verdict}</b>
    `;
    drawChart(res);
  }

  // ===== Sugerencias =====
  function computeSuggestions(){
    const pm=parseMonth(state.month); if(!pm) return {note:"Mes inválido", freedom:null, cap:null};
    const y=pm.y, m=pm.m;
    const maxF = state.freedomDebt;
    let best = null;
    function score(res){ return (res.capPagoReal||0)*100000 + (res.saldo||0); }
    for(let f=0; f<=maxF; f+=25){
      const prev=state.freedomPay, prevCap=state.capPay;
      state.freedomPay = f; state.capPay = state.capDebt;
      const res = simulateMonth(y,m,null);
      const ok = !res.pisoViolado && res.applePagado && res.rentaPagada;
      if(ok && (!best || score(res)>best.sc)) best={f, cap:state.capDebt-res.capDebt, sc:score(res)};
      state.freedomPay=prev; state.capPay=prevCap;
    }
    if(best){
      const lo=Math.max(0,best.f-24), hi=Math.min(maxF,best.f+24);
      for(let f=lo; f<=hi; f+=5){
        const prev=state.freedomPay, prevCap=state.capPay;
        state.freedomPay = f; state.capPay = state.capDebt;
        const res=simulateMonth(y,m,null);
        const ok=!res.pisoViolado && res.applePagado && res.rentaPagada;
        if(ok && score(res)>best.sc) best={f, cap:state.capDebt-res.capDebt, sc:score(res)};
        state.freedomPay=prev; state.capPay=prevCap;
      }
      return {freedom:best.f, cap:best.cap, note:"Maximiza Capital One sin romper piso."};
    }
    return {freedom:null, cap:null, note:"No combinación segura."};
  }

  $("calcSug").onclick=function(){
    clearErr();
    const s = computeSuggestions();
    if(s.freedom==null){
      $("sugText").innerHTML = `<span class="pill bad">Sin solución</span> ${s.note}`;
    }else{
      const moneyFmt=(x)=>"$"+Number(x||0).toFixed(2);
      $("sugText").innerHTML = `Sugerido: Freedom = ${moneyFmt(s.freedom)} · Capital One = ${moneyFmt(s.cap)}<br/><span class="mini">${s.note}</span>`;
    }
  };
  $("applySug").onclick=function(){
    const s = computeSuggestions();
    if(s.freedom!=null){ state.freedomPay = s.freedom; $("freedomPay").value = s.freedom; }
    if(s.cap!=null){ state.capPay = s.cap; $("capPay").value = s.cap; }
    save(); renderKpis();
  };

  // ===== Chart =====
  function drawChart(res){
    const cvs=$("chart"), ctx=cvs.getContext('2d');
    const W=cvs.width=cvs.clientWidth*2, H=cvs.height=220*2; ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='#334155'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(40,H-40); ctx.lineTo(W-20,H-40); ctx.stroke();
    ctx.font='28px system-ui';
    const data=[res.totIncome, res.totPayments, res.saldo, Math.max(0, res.saldo-state.minBal)];
    const labels=['Ingresos','Pagos','Saldo','Libre'];
    const max=Math.max(...data,1); const barW=Math.floor((W*0.7)/data.length); const startX=Math.floor((W-barW*data.length)/2);
    data.forEach((v,i)=>{ const h=Math.round((v/max)*(H-120)); const x=startX+i*barW+20, y=H-40-h;
      ctx.fillStyle= i===1? '#ef4444' : (i===3? '#22c55e' : '#60a5fa'); ctx.fillRect(x,y,barW-40,h);
      ctx.fillStyle='#e5e7eb'; ctx.fillText(labels[i], x, H-10); ctx.fillText('$'+Math.round(v), x, y-10);
    });
  }

  // ===== Eventos UI =====
  $("saveConfig").onclick=()=>{
    state.month = $("month").value;
    state.saldo = N($("saldo").value);
    state.minBal = N($("minBal").value);
    state.rent = N($("rent").value);
    state.weekly = N($("weekly").value);
    state.autoFri = $("autoFri").value;
    state.omitFirst = $("omitFirst").checked;
    save(); renderKpis();
  };
  $("updateDebts").onclick=()=>{
    state.appleDebt = N($("appleDebt").value);
    state.freedomDebt = N($("freedomDebt").value);
    state.freedomPay = N($("freedomPay").value);
    state.capDebt = N($("capDebt").value);
    state.capPay = N($("capPay").value);
    state.capForce = $("capForce").checked;
    state.carIns = N($("carIns").value);
    state.cards.find(c=>c.name==='Apple Card').debt = state.appleDebt;
    state.cards.find(c=>c.name==='Freedom (Chase)').debt = state.freedomDebt;
    state.cards.find(c=>c.name==='Freedom (Chase)').pay = state.freedomPay;
    state.cards.find(c=>c.name==='Capital One').debt = state.capDebt;
    state.cards.find(c=>c.name==='Capital One').pay = state.capPay;
    save(); clearErr(); renderKpis();
  };
  $("clear").onclick=()=>{ $("tblPlan").querySelector("tbody").innerHTML=""; clearErr(); $("planSummary").innerHTML=""; };
  $("gen").onclick=generatePlan;

  // ===== Render KPIs =====
  function renderKpis(){
    const hold = initialMandatory();
    const safe = Math.max(0, state.saldo - state.minBal - hold);
    setKpis({saldo:state.saldo, floor:state.minBal, rent:state.rent, hold, safe});
    $("periodLabel").textContent = `Mes: ${state.month}`;
  }

  renderKpis();
})();
</script>

<!-- Print limpio -->
<style media="print">
  header{display:none}
  body{background:#fff;color:#000}
  .card{border:1px solid #ccc}
  .btn,.actions{display:none}
  canvas{border:1px solid #ccc}
</style>
</body>
</html>
